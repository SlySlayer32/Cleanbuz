---
name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-Merge Dependabot PRs
    runs-on: ubuntu-latest
    
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Wait for CI checks
        uses: actions/github-script@v8
        with:
          script: |
            const maxWaitTime = 10 * 60 * 1000; // 10 minutes
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              
              // Get check runs for the PR
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              // Get status checks
              const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              // Check if all checks have completed
              const allChecksComplete = checkRuns.check_runs.every(check => 
                check.status === 'completed'
              );
              
              if (!allChecksComplete) {
                console.log('Waiting for checks to complete...');
                await new Promise(resolve => setTimeout(resolve, checkInterval));
                continue;
              }
              
              // Check if all checks passed
              const allChecksPassed = checkRuns.check_runs.every(check => 
                check.conclusion === 'success' || check.conclusion === 'skipped'
              ) && (statuses.state === 'success' || statuses.total_count === 0);
              
              if (allChecksPassed) {
                console.log('✅ All checks passed!');
                core.setOutput('checks_passed', 'true');
                return;
              } else {
                console.log('❌ Some checks failed');
                core.setOutput('checks_passed', 'false');
                return;
              }
            }
            
            console.log('⏱️ Timeout waiting for checks');
            core.setOutput('checks_passed', 'timeout');
      
      - name: Determine if auto-merge is appropriate
        id: should-merge
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          DEPENDENCY_NAME="${{ steps.metadata.outputs.dependency-names }}"
          
          echo "Update type: $UPDATE_TYPE"
          echo "Dependency: $DEPENDENCY_NAME"
          
          # Safe to auto-merge: patch and minor updates
          if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]] || \
             [[ "$UPDATE_TYPE" == "version-update:semver-minor" && ! "$DEPENDENCY_NAME" =~ ^(react|next|@supabase) ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=Safe update type: $UPDATE_TYPE" >> $GITHUB_OUTPUT
          # Dev dependencies minor updates are also safe
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] && \
               [[ "$DEPENDENCY_NAME" =~ ^(@types|eslint|prettier|typescript) ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=Dev dependency minor update" >> $GITHUB_OUTPUT
          # GitHub Actions updates are generally safe
          elif [[ "${{ steps.metadata.outputs.package-ecosystem }}" == "github_actions" ]]; then
            echo "auto_merge=true" >> $GITHUB_OUTPUT
            echo "reason=GitHub Actions update" >> $GITHUB_OUTPUT
          else
            echo "auto_merge=false" >> $GITHUB_OUTPUT
            echo "reason=Requires manual review: $UPDATE_TYPE for $DEPENDENCY_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: Add auto-merge label
        if: steps.should-merge.outputs.auto_merge == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['auto-merge-enabled']
            });
      
      - name: Enable auto-merge
        if: steps.should-merge.outputs.auto_merge == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            // First, approve the PR
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'APPROVE',
                body: '✅ Auto-approved by Dependabot Auto-Merge workflow\n\n**Reason:** ${{ steps.should-merge.outputs.reason }}\n\nThis PR will be automatically merged once all CI checks pass.'
              });
              console.log('✅ PR approved');
            } catch (error) {
              console.log(`Could not approve PR: ${error.message}`);
            }
            
            // Enable auto-merge with squash
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                merge_method: 'squash'
              });
              console.log('✅ Auto-merge enabled - PR will merge when checks pass');
            } catch (error) {
              console.log(`Could not enable auto-merge: ${error.message}`);
              
              // If auto-merge API fails, try commenting with instructions
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '✅ This PR is approved for auto-merge.\n\n' +
                      '**Reason:** ${{ steps.should-merge.outputs.reason }}\n\n' +
                      'Please manually enable auto-merge or merge once CI passes.'
              });
            }
      
      - name: Comment on manual review requirement
        if: steps.should-merge.outputs.auto_merge == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⚠️ **Manual Review Required**\n\n' +
                    '**Reason:** ${{ steps.should-merge.outputs.reason }}\n\n' +
                    'This update requires manual review before merging. Please:\n' +
                    '1. Review the changelog for breaking changes\n' +
                    '2. Test locally if necessary\n' +
                    '3. Approve and merge when ready'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['requires-review']
            });
